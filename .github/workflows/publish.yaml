name: Build and publish

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }}/${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: blacksmith-16vcpu-ubuntu-2404
            os: linux
            arch: amd64
          - runner: blacksmith-16vcpu-ubuntu-2404-arm
            os: linux
            arch: arm64
          - runner: macos-latest
            os: macos
            arch: arm64
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.tag }}

      - uses: dtolnay/rust-toolchain@1.92.0

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ hashFiles('Cargo.lock') }}

      - name: Build CLI binary
        run: |
          cargo build --release --bin bauplan
          mkdir -p "$RUNNER_TEMP/data/scripts"
          cp target/release/bauplan "$RUNNER_TEMP/data/scripts/"

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          args: --release --out dist --find-interpreter --data ${{ runner.temp }}/data
          container: "off"

      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: dist

      - name: Create CLI tarball
        run: |
          mkdir -p "${RUNNER_TEMP}/${{ inputs.tag }}"
          cp target/release/bauplan README.md CHANGELOG.md LICENSE* \
            "${RUNNER_TEMP}/${{ inputs.tag }}"
          tar -C "${RUNNER_TEMP}" --numeric-owner \
            -cvzf "bauplan-${{ inputs.tag }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" "${{ inputs.tag }}"

      - name: Upload CLI tarball
        uses: actions/upload-artifact@v5
        with:
          name: cli-tarball-${{ matrix.os }}-${{ matrix.arch }}
          path: "bauplan-${{ inputs.tag }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz"

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Publish wheels to PyPI
        run: uv publish 'wheels-*/*'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Upload CLI tarballs to GitHub release
        run: gh release upload "${{ inputs.tag }}" cli-tarball-*/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
